<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>6502 Exploration Lab</title>
<link rel="stylesheet" href="google-code-prettify/prettify.css">
<link rel="stylesheet" href="styles/prettify-theme.css">
<script defer src="google-code-prettify/prettify.js"></script>
<script defer src="google-code-prettify/run_prettify.js"></script>
<link rel="stylesheet" href="styles/main.css">
</head>

<!-- Generated by srcweave. https://github.com/justinmeiners/srcweave -->
<h1 id="gamepad">Gamepad</h1>




<h2 id="not-using-interrupts">Not using interrupts</h2>


<p>Start simple. Make sure we understand reading from one peripheral and writing to another.</p>

<p>In a loop:</p>

<ol>
<li>Read the value of each gamepad button.</li>
<li>Write each value to the display.</li>
</ol>


<h2 id="reading-the-value-of-a-gamepad-button">Reading the value of a gamepad button</h2>


<h3>How do we read the value of the middle button?</h3>

<p><code>
PA0 ----- MIDDLE
PA1 ----- UP
PA2 ----- DOWN
PA3 ----- LEFT
PA4 ----- RIGHT
</code></p>

<p>How do we read the value of PA0?</p>

<p><del>The signal is going to be on the data bus. It will hit the VIA (the WD65C22) on pin 2.</del></p>

<p>How do we tell the VIA to &ldquo;latch&rdquo; that value, so that we can read it at some point in the future? <del>For that matter, <em>must</em> we tell the VIA to latch the value? If it&rsquo;s on the bus and we are using the value immediately, can the MPU just read it directly?</del></p>

<p><del>For the sake of doing things the way they are likely to be done in other future situations, I&rsquo;ll stick with communicating through the VIA. But let&rsquo;s leave it as a TODO to come back and test our understanding.</del></p>

<p><del>TODO: Try bypassing the VIA and reading directly from A&hellip;</del></p>

<p>Ohhhh. <code>PA0</code> is <em>not</em> on the bus. <code>D0</code> is on the bus. Pins on one side of the VIA are the peripheral port pins. Pins on the <em>other</em> side are the bus pins.</p>

<p>Ok. So. We set the VIA to read from it&rsquo;s <code>B</code> port. It&rsquo;s possible to set per-pin-level read/write. For now, for this first experiment, we only need to read 1 pin, the <code>PA0</code> &ldquo;middle&rdquo; pin. But it doesn&rsquo;t really matter. We&rsquo;ll probably set all of them to read and just pick the one we want when it&rsquo;s time to do the display logic.</p>

<h4>Latching</h4>

<p>Each port has input latching capability. Must we use that capability? What does it really mean?</p>

<blockquote><p>When reading the Peripheral Port (PA or PB), the contents of the corresponding
Input Register (IRA or IRB) is transferred onto the Data Bus. When the input
latching feature is disabled, IRA will reflect the logic levels present on the
PA bus pins. However, with input latching enabled and the selected active
transition on Peripheral A Control 1 (CA1) having occurred, IRA will contain the
data present on the PA bus lines at the time of the transition. In this case,
once IRA has been read, it will appear transparent, reflecting the current state
of the PA bus pins until the next CA1 latching transition.</p></blockquote>

<p>It sounds like this is kind of related to the strikethroughed text above. With input latching disabled, the values on <code>PA0</code> are <em>passed through</em> to <code>D0</code>. Since we&rsquo;re just experimenting, passthrough is all we need.</p>

<p>How would you set latching enabled if you wanted to? With the Auxiliary Control Register. It&rsquo;s at memory address $0B. If the lowest bit of that register is 1, then port <code>A</code> latching is enabled. The second lowest bit controls <code>B</code>.</p>

<h4>Data direction registers</h4>

<p>See page 8 of the w65c22 datasheet.</p>

<blockquote><p>Both PA and PB operate in conjunction with a Data Direction Register (DDRA or
DDRB). Under program control, the DDRA and DDRB specify which pins within the
port bus are to be designated as inputs or outputs. Logic 0 in any bit
position of the register will cause the corresponding pin to serve as an
input; while a logic 1 will cause the pin to serve as an output.</p></blockquote>

<h3>The code to set the VIA to read from port <code>A</code>.</h3>

<p>See the table on page 8 of the WD65C22 datasheet.</p>

<p>Writing <code>1</code> to <code>DDRA</code> (address 0x03 of the VIA) sets it to input mode. Then, writing 0 to any pin will set that pin to input mode.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id=":gamepad.s" href="#:gamepad.s">/gamepad.s</a></em></strong></span>
<pre class="prettyprint"><code class="">lda #$01
sta $6003
</code></pre>
</div>


<h3>The code to read the value from port <code>A</code>.</h3>

<p>Since we&rsquo;re not waiting on any handshake, data ready, or latch, then we can just start reading straight from the memory address.</p>

<p>The only thing we need to consider, I think, is the &ldquo;bus enable&rdquo; pin on the MPU.</p>

<blockquote><p>The Bus Enable (BE) input signal provides external control of the Address,
Data and the RWB buffers. When Bus Enable is high, the Address, Data and RWB
buffers are active. When BE is low, these buffers are set to the high
impedance status. Bus Enable is an asynchronous signal.</p></blockquote>

<p>Oh. And the RWB pin.</p>

<blockquote><p>The Read/Write (RWB) output signal is used to control data transfer. When in
the high state, the microprocessor is reading data from memory or I/O. When in
the low state, the Data Bus contains valid data to be written from the
microprocessor and stored at the addressed memory or I/O location. The RWB
signal is set to the high impedance state when Bus Enable (BE) is low.</p></blockquote>

<p>So. <code>BE</code> high and <code>RWB</code> high.</p>

<p>Where is <code>BE</code>? I don&rsquo;t see it anywhere on the schematics from <a href="https://github.com/tebl/BE6502-Build-a-65c02-computer">https://github.com/tebl/BE6502-Build-a-65c02-computer</a>.</p>

<p>I had the thought that maybe it was just <em>always</em> high. Maybe that was the way Ben Eater designed it. Maybe we never <em>need</em> it to be low, for basic use.</p>

<p>If that were the case, then maybe the code of the 6502 monitor would point me to how/where it&rsquo;s handled.</p>

<p>Sure enough. The monitor writes to <a href="https://github.com/tebl/BE6502-Build-a-65c02-computer/blob/4ca727ed6329626ecbd858c24cd1ece420efed22/software/arduino/6502-monitor/6502-monitor/constants.h#L12">Digital Pin 4</a> of the Arduino when it wants to change the <code>BE</code> pin. Using the KiCad schematics, I tracked digital pin 4 of the arduino down to a wire labeled &ldquo;Pin 21&rdquo;. That&rsquo;s it. It&rsquo;s not actually labeled <code>BE</code> anywhere. Just &ldquo;Pin 21&rdquo;.</p>

<p>Anyways&hellip; we don&rsquo;t need to muck with <code>BE</code>. The only reason to do so would be if you want something <em>other than</em> the 6502 to read/write from something on the data bus. The only possible thing that <em>could</em> do that, in our case, is the Arduino. And that&rsquo;s only in monitor mode. It&rsquo;s useful for doing things like dumping RAM.</p>

<p>Ok. So. Long story short: we only need <code>RWB</code> high.</p>

<p>EDIT: Ohhhh. Noooo. <code>RWB</code> is kind of a &ldquo;read-only&rdquo; pin. It&rsquo;s just the processor telling you whether it&rsquo;s reading or writing. See <a href="https://youtu.be/LnzuMJLZRdU?list=PLowKtXNTBypFbtuVMUVXNR0z1mu7dp7eH&amp;t=1036">Ben Eater&rsquo;s first video at 17:00</a>.</p>

<p>Duh. It says right there on page 10 of the <a href="file:///home/eihli/src/be6502/datasheets/w65c02s.pdf">6502 datasheet</a>. &ldquo;The Read/Write (RWB) <em><em>output</em></em> signal&hellip;&rdquo;</p>

<p>God all mighty. Ok.</p>

<p>So.</p>

<p>Bus Enable is always high. RWB is output. What do we need to do to read from Port A? Just fucking read it.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id=":gamepad.s_2" href="#:gamepad.s_2">/gamepad.s</a></em></strong> <a href="#:gamepad.s">+=</a></span>
<pre class="prettyprint"><code class="">lda $6001
</code></pre>
</div>

</body>
</html>
